---
editor_options: 
  markdown: 
    wrap: sentence
---

# 시계열 그래프{#chapter-ts-plot}

모든 통계자료 분석의 첫 번째 단계는 적절한 그래프를 작성하는 것이다.
자료의 전체 모습을 확인하는데 자료의 시각화 만큼 효과적인 방법도 없을 것이다.
시계열분석에서도 이 규칙은 예외 없이 적용된다고 할 수 있다.
그럼 시계열 자료는 어떤 특징을 갖고 있으며, 일반적인 통계 자료와 어떤 차이가 있는지 알아보도록 하자.

## 시계열 자료

동일한 대상을 시간의 흐름에 따라 계속해서 관측할 수 있는데, 이러한 과정에서 생성된 자료를 시계열자료라고 한다.
시계열자료에는 기온과 같이 연속적으로 생성은 되지만 일정한 간격을 두고 관측하는 연속 시계열 자료가 있고, 일일 전기 소비량과 같이 자료의 생성 및 관측에 일정한 간격이 있는 이산 시계열 자료가 있다.
이 책에서는 이산 시계열 자료를 대상으로 하는 분석 기법을 다루고자 한다.

일정한 간격을 두고 관측되는 시계열 자료의 관측 시점의 차이를 시차 (time lag)라고 한다.

### 종단 자료(cross-sectional data)와의 비교

시계열 자료는 여러 시점에 걸쳐서 동일 개체에 대하여 반복해서 관측된 자료를 의미한다.
반면에 종단 자료는 어느 특정 시점에서 여러 개체에 대해 관측된 자료를 의미한다.
두 형태의 자료에 대한 예로써 다음의 표를 살펴보자.

첫 번째 표는 특정 시점에 4개 기업에 대한 주가, 유동자산 및 부채를 조사한 모의 자료이다. 
회귀분석 등으로 분석이 가능한 형태의 자료라고 할 수 있다. 

+--------+--------+----------+--------+
| 기업   | 주가   | 유동자산 | 부채   |
+:======:+:======:+:========:+:======:+
| A      | 56,500 | 95       | 55     |
+--------+--------+----------+--------+
| B      | 24,000 | 20       | 23     |
+--------+--------+----------+--------+
| C      | 86,000 | 110      | 98     |
+--------+--------+----------+--------+
| D      | 12,000 | 32       | 13     |
+--------+--------+----------+--------+

: 종단자료


두 번째 표는 3월 2일부터 3월 5일까지 A 기업과 B 기업의 주가 자료라고 하자. 
일일 간격으로 4일 동안 두 기업의 주가를 반복해서 관측한 자료이므로 시계열 자료에 해당한다.

+------------+---------------+---------------+
| 일시       | A 기업의 주가 | B 기업의 주가 |
+:==========:+:=============:+:=============:+
| 3.2        | 56,500        | 24,000        |
+------------+---------------+---------------+
| 3.3        | 54,200        | 23,100        |
+------------+---------------+---------------+
| 3.4        | 54,600        | 22,300        |
+------------+---------------+---------------+
| 3.5        | 52,100        | 23,200        |
+------------+---------------+---------------+

: 시계열자료


### 시계열 예측 

통계적 추론을 위한 기본적인 가정은 자료가 서로 독립이고 동일한 분포를 갖고 있다는 것이다. 
따라서 통계 자료가 서로 독립이 아니라면 통계적 예측 모형을 효과적으로 적용하기 어렵다고 할 수 있다.

앞 절에서 살펴본 종단자료는 거의 모든 경우에 행의 순서를 뒤섞어도 문제가 되지 않는 자료이기 때문에, 
독립성에는 큰 문제가 없는 것이 일반적인 상황이다. 따라서 이러한 형태의 자료에 대해서는 무리 없이 
선형회귀모형 등을 적합시켜 예측을 효과적으로 실시할 수 있다. 

반면에 시계열자료의 경우에는 예컨대 3월 3일 주가는 3월 2일 주가와 독립이 될 수 없는 상황이다. 
따라서 시계열자료에 대한 예측모형은 독립성을 가정하고 있는 일반적인 통계모형을 사용할 수 없는 것이다.  

우리는 앞으로 시계열자료를 대상으로 효과적인 예측을 실시할 수 있는 다양한 모형을 살펴볼 것이다.
시계열 예측은 많은 분야에서 필수적인 사항이고, 따라서 전문가가 많이 필요한 분야라고 할 수 있다. 


## 시계열 그래프 작성

시계열자료는 관측 결과 뿐 아니라 관측이 시작된 시점과 끝난 시점, 관측 간격으로 이루어져 있으며, 
이러한 정보를 R에서는 'ts' 객체에 저장할 수 있다. 

예를 들어 `AirPassengers`는 미국 Pam Am 항공사의 1949년부터 1960년까지 월별 항공기 탑승 승객 수가 
천 명 단위로 입력되어 있다. 

```{r}
AirPassengers
```

`AirPassengers`는 `ts` 객체이다. 출력된 형태는 2차원 구조로 보이지만, 벡터와 같은 1차원 배열이다. 
`ts` 객체의 특성은 다음과 같이 알아볼 수 있다. 

```{r}
class(AirPassengers)
start(AirPassengers)
end(AirPassengers)
frequency(AirPassengers)
```

`AirPassengers`의 시작 시점은 1949년 1월이고, 종료 시점은 1960년 12월이다. 
함수 `frequency()`는 시계열자료의 주기, 즉 계절 요소의 반복 기간을 보여주고 있다. 


### `ts` 객체 생성

만일 일반 벡터를 `ts` 객체로 변환하려고 한다면, 함수 `ts()`를 사용해야 한다. 
사용법은 `ts(data, start, end, frequency)`와 같은데, `data`는 시계열자료로 변환할 벡터이고
`start`는 자료의 시작점을 지정하는 것으로써, 2020년 1월을 시작점으로 지정한다면 `start = c(2020, 1)`과 같이
지정하면 된다. `end`는 자료의 종료 시점을 지정하는 것이며, 방법은 `start`와 동일하다. 
만일 `end`를 생략한다면 `data`에 있는 모든 자료가 시계열자료로 변환된다. 
`frequency`는 자료의 주기를 지정하는 것으로써, 연간 자료는 1, 분기별 자료는 4, 월별 자료는 12를 지정하면 된다. 

* 예제: 백화점 매출액 자료

`depart.txt`는 어떤 백화점의 1984년 1월부터 1988년 12월까지의 월별 매출액이 입력되어 있다.
이것을 R로 불러와서 `ts` 객체로 변환시켜보자.

```{r}
depart <- scan("https://raw.githubusercontent.com/yjyjpark/TS-with-R/main/Data/depart.txt")
depart.ts <- ts(depart, start = c(1984, 1), frequency = 12)
depart.ts
```


### 시계열 그래프 작성{#section-ts-plot}

시계열 그래프란 시계열자료를 관측된 순서대로 선으로 연결한 그래프를 의미한다. 
작성 함수는 `ggplot2::autoplot()`인데, 이 함수는 입력되는 객체의 특성에 가장 적합한 그래프를 작성해 주는 함수로서
앞으로 매우 유용하게 사용된다. 
함수 `autoplot()`으로 시계열 그래프를 작성하기 위해서는 패키지 `forecast`도 필요한데, 
패키지 `fpp2`를 불러오면 필요한 패키지가 모두 같이 로딩된다.

```{r, message=TRUE}
library(fpp2)
```

* 예제: 백화점 매출액 자료

백화점 매출액 자료인 `depart.ts`의 시계열 그래프를 작성해 보자. 

```{r depart, fig.cap="백화점 월별 매출액"}
autoplot(depart.ts) +
  labs(title = "Monthly sales of a department store", x = "Year", y = NULL)
```

* 예제: 지구 온도 자료

1856년 1월부터 2005년 12월까지 지구 온도 자료가 `global.txt`에 입력되어 있다. 
이 자료의 시계열 그래프를 작성해 보자. 

```{r global, fig.cap="1856년부터 2005년까지 지구 온도 시계열 그래프"}
global <- scan("https://raw.githubusercontent.com/yjyjpark/TS-with-R/main/Data/global.txt")
global.ts <- ts(global, start = c(1856, 1), frequency = 12)
autoplot(global.ts) +
  labs(title = "Global Temperature 1985 ~ 2005", x = "Year", y = NULL)
```

Figure \@ref(fig:global)에서 볼 수 있는 것은 대략 1970년 이후로 지속적인 상승 패턴이 있다는 점이다. 
1970년 이후 자료에 대한 시계열 그래프를 다시 작성해 보자. 
이것을 위해서는 이미 생성된 `ts` 객체에서 일부분을 선택해야 하는데, 이 작업은 함수 `window()`로 할 수 있다. 
사용법은 `window(ts, start, end)`이다. 

이제 1970년 1월 이후 자료에 대한 시계열 그래프를 작성해 보자. 

```{r global-1970, fig.cap="1970년부터 2005년까지 지구 온도 시계열 그래프"}
global.1970 <- window(global.ts, start = 1970)
autoplot(global.1970) +
  labs(title = "Global Temperature 1970 ~ 2005", x = "Year", y = NULL)
```

Figure \@ref(fig:global-1970)의 시계열 그래프에 회귀직선을 추가하면, 상승 추세를 조금 더 명확하게 확인할 수 있다. 

```{r global-1970-lm, fig.cap="시계열 그래프에 회귀직선 추가"}
autoplot(global.1970) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Global Temperature 1970 ~ 2005", x = "Year", y = NULL)
```


* 예제: 다중 시계열 그래프

`cbe.txt`에는 호주에서 1958년부터 초콜릿, 맥주 및 전기의 월별 생산량이 입력되어 있다. 

```{r}
CBE <- readr::read_table("https://raw.githubusercontent.com/yjyjpark/TS-with-R/main/Data/cbe.txt")
CBE %>% print(n = 3)
```

tibble로 입력된 자료를 `ts` 객체로 변환해 보자. 
함수 `ts()`에 데이터 프레임을 입력하면 행렬로 변환되어 처리되는데, 열을 구성하는 벡터를 각각 `ts` 객체로 변환시킨다.   

```{r}
cbe <- ts(CBE, start = 1958, frequency = 12)
head(CBE, n = 3)
```

`cbe`에는 시계열자료 `choc`, `beer`와 `elec`로 구성되어 있음을 알 수 있다. 
이러한 다중 시계열 자료를 함수 `autoplot()`에 입력하면 다중 시계열 그래프가 작성된다. 

```{r cbe-1, fig.cap="다중 시계열 그래프"}
autoplot(cbe) +
  ylab(NULL)
```


만일 다중 시계열자료의 scale에 큰 차이가 있다면 하나의 그래프에 작성하는 것보다는 facet 그래프를 작성하는 것이 더 효과적이다. 

```{r cbe-2, fig.cap="다중 시계열 그래프"}
autoplot(cbe, facets = TRUE) +
  ylab(NULL)
```


### Seasonal 그래프{#section-seasonal-plot}

시계열자료에 계절 변동 요소가 있는 경우에, 그 특성을 명확하게 나타낼 그래프가 있다면 많은 도움이 될 것이다. 
계절 요소가 있는 시계열자료에 대해서 \@ref(section-ts-plot)절에서 살펴본 그래프를 작성해도 어느 정도 계절 요소를 확인할 수 있는 것은 사실이지만, 계절 요소만을 정밀하게 확인하기는 어려움이 있다고 하겠다. 
이 절에서 살펴볼 seasonal 그래프는 기본적으로 시계열자료를 측정된 주기 (월 또는 분기)별로 나타낸 그래프이다.  
이러한 그래프를 작성하면 계절 변동의 패턴을 쉽게 확인 할 수 있으며, 또한 전체 측정 기간 동안 계절 패턴에 어떤 변화가 있었는지, 변화가 있었던 시점 등을 쉽게 확인할 수 있게 된다.    

살펴볼 그래프는 `forecast::ggseasonplot()`과 `forecast::ggsubseriesplot()`으로 작성되는 그래프와 분기별 나란히 서 있는 상자그림이다. 

* 예제: `AirPassengers`

우선 함수 `ggseasonplot()`으로 그래프를 작성해 보자.

```{r season-AP-1, fig.cap="함수 `ggseasonalplot()`으로 작성된 seasonal 그래프"}
ggseasonplot(AirPassengers)
```

X축 변수는 이 자료의 주기인 월이고, 각 연도는 색으로 구분되어 있다. 
각 연도에 적용된 색은 그래프 오른쪽에 범례로 정리되어 있다. 
연도에 대한 범례를 그래프 안에 일종의 라벨로 표시하고자 한다면 옵션 `year.labels = TRUE`를 포함시키면 된다. 

```{r season-AP-2, fig.cap="함수 `ggseasonalplot()`으로 작성된 seasonal 그래프"}
ggseasonplot(AirPassengers, year.labels = TRUE)
```


연도에 대한 라벨을 왼쪽에도 함께 나타낼 필요가 있다면 옵션 `year.labels.left = TRUE`를 포함시키면 된다. 
```{r season-AP-3, fig.cap="함수 `ggseasonalplot()`으로 작성된 seasonal 그래프"}
ggseasonplot(AirPassengers, year.labels = TRUE, year.labels.left = TRUE)
```

극좌표 형태롤 나타내고자 한다면, 옵션 `polar = TRUE`를 포함시키면 된다. 

```{r season-AP-4, fig.cap="함수 `ggseasonalplot()`으로 작성된 seasonal 그래프"}
ggseasonplot(AirPassengers, polar = TRUE)
```

이번에는 함수 `ggsubseriesplot()`으로 그래프를 작성해 보자. 
월별로 자료를 구분해서 선 그래프를 작성하고, 파란 선으로 월별 평균을 표시한 그래프이다. 

```{r season-AP-5, fig.cap="함수 `ggsubseriesplot()`으로 작성된 seasonal 그래프"}
ggsubseriesplot(AirPassengers)
```

월별로 구분된 자료를 대상으로 상자그림을 작성해서 보는 것도 의미있는 분석이 될 수 있을 것이다. 
상자그림을 작성하기 위해서는 `ts` 객체인 `AirPassengers`를 숫자형 벡터로 변환시키고,
각 자료를 주기를 함수 `cycle()`로 추출해서 요인으로 변환시키는 것이 필요하다. 

```{r season-AP-6, fig.cap="상자그림으로 나타낸 계절 변동 요소"}
tibble::tibble(AP = as.numeric(AirPassengers), mon = as.factor(cycle(AirPassengers))) %>% 
  ggplot(aes(x = mon, y = AP)) +
  geom_boxplot() +
  labs(x = "Month", y = "Air Passengers")
```












